
## uniswap 的基本原理
```
Uniswap 是 去中心化交易所（DEX），
使用 AMM (Automated Market Maker) 自动做市商的方式  。

中心化交易所: 订单簿（Order Book）+ 撮合系统(最高买价 碰撞 最低卖价) 的自动交易机制。
Uniswap : AMM 通过 流动性池（Liquidity Pool）和 恒定乘积公式(x * y = k） 决定价格，并完成交易。

流动性池（Liquidity Pools）: 存入一个交易对(token0和token1) 资产的池子（如 ETH 和 USDT）。
流动性提供者（LP）， 向池子 中存入 资产，并 获取 手续费收益 的用户，  。
交易者 , 从流动性池子中，购买资产，并支付手续费

无常损失:
无常损失是提供流动性时，价格偏离存入价导致 LP 资产价值低于直接持币的差额。
价格上涨或下跌都会造成 LP 价值低于持币，偏离越大损失越大。
LP 收益主要靠手续费和奖励抵消损失，高波动代币 HODL 更安全，高交易量低波动池提供流动性更有利。

```

## 恒定乘积公式
```
恒定乘积公式L: x * y = k :
X ：token0 的 数量
Y : token1 的 数量

定价公式: 
token0(对token1）的价格=Y/X

输出计算: 假如输入 Xa，根据公式
(x+xa) * (y-ya) = x*y  
计算出：
Ya=(Y- (X * Y) / (X+Xa) )
```


## swap ：LP 获得的手续费（ lpUserFee）
```
一. 计算公式:
LP 获得的手续费 = 单位流动性累计手续费 * 流动性

二. 过程  : 
--------手续费指数
核心: 手续费指数= 每单位流动性累计手续费= 交易手续费/池子总流动性

1.交易池子维护了一个 池子的手续费指数，每次更新 :
totalFee=totalFeeOld + Fee/ 池子总流动性

手续费指数, 避免了池子流动性变化的干扰

2. 流动性提供者 维护了一个 用户的手续费指数，每次更新 :
a. LP新增的手续费 = （池子最新 手续费指数totalFee- 用户 手续费指数的userFee） * LP提供的流动性
b. 更新 userFee=totalFee

更新策略：
1.定时更新
2.触发更新 : 查看账户信息 或者 移除流动性的时候

```

## uniswap 怎么防止滑点过大
```
1. 用户设置 minAmountOut，售出价格 如果小于 minAmountOut 则回滚
2. 代码设置滑点容忍度，滑点过大则回滚
```

## 数据同步过程中,如何处理区块链分叉问题？
```
处理方法
1. 等待 12 个区块确认（约 3 分钟）后再处理数据。
2. 同步 removed 字段，其中 removed = true 表示事件无效且已被废弃。

removed 字段是类似 blockNumber 的一个属性字段

由于区块已经被废弃，所以 同步 removed=true的数据方法
1. websocket 监控
2. 根据实时记录的blockhash ,进行循环查询

```

## uniswap v3 的主要更新：
```
1. 池子数量和结构
V2：每个交易对只有一个池子。
V3：每个交易对可有多个池子（按手续费等级区分），每个池子管理不同价格区间的流动性。

2. 流动性提供方式
V2：LP 必须提供等值的两种代币，流动性在整个价格区间均有效。
V3：LP 可以选择指定价格区间（tickLower、tickUpper）提供流动性，支持单边流动性，资本效率更高。

3. 手续费（Fee）
V2：固定 0.3%，全部归 LP。
V3：支持多档手续费等级（0.05% / 0.3% / 1%），协议收取部分手续费。

4. 添加了闪电贷
```
