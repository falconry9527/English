## gas优化
```
一.常规优化
在存储中使用 uint256 代替较小的整数类型，多个小的整数类型，会被打包在一个slot，存在 打包和解包的资源消耗。
使用 memory, 存储 参数 和 临时变量，中间计算结果 ，以降低存储的gas 消耗。
使用 calldata 存储 外部函数 参数，以降低存储的gas 消耗。

二.代码架构的优化:
a. 链上只完成核心逻辑，复杂计算给到链下
比如: 贷款合约中，链下监控价格，触发链上清算，链上验证和执行

b. 贷款合约中，白名单机制使用 Merkle 而不是 mapping, 减少数据存储

c. iziswap中，定时计算 流动性提供者(LP)的手续费收入
每次swap ,流动性提供者(LP) 的手续费收入都会变化，如果每次计算 ，很消耗gas，怎么解决
1. 定时批量更新（Batching Updates）: 每10分钟更新一次
2. 当用户查看的时候更新

交易手续费 ： 平台抽取 1/6 , LP 获得 5/6 
0.05%（低风险池）
0.30%（中等波动池）
1.00%（高波动池）

```

##  安全和防御攻击
```
名单机制 :防止 Sybil 攻击

多签机制 ：防止密钥丢失或被盗: 
如果管理员想要提取交易费，需要至少 5 名管理员中的 3 名批准。
    使用多重签名机制，防止密钥丢失或被盗（OpenZeppelin 的 AccessControl + 自定义签名验证）。

重入攻击防护 :
1. 使用 ReentrancyGuard 合约防止重入攻击。
2. 先检查,再修改状态, 最后 交互/资产转账（Check-Effect-Interaction）
3. 拉取支付（Pull Over Push）模式: 不直接向用户转账，而是让用户主动提取。
   iziswap 中，流动性提供者（lp），赎回资产 ， 存入余额，让用户自己提取，而不是直接转账给账户

规范代码习惯: 不能随意调整变量的大小和顺序
```

##  UUPS 和 透明代理（Transparent Proxy）的相同和区别
```
设计目的 : 实现合约逻辑部分 可升级，同时保持状态不丢失。
模式相同 : 代理合约 + 实现合约
代理合约 : 保存状态变量，接收用户调用，通过 delegatecall 转发逻辑。
实现合约 : 包含可执行代码。

不同点:
Transparent Proxy: 升级逻辑在代理合约，更费gas，更安全
UUPS :升级逻辑在实现合约，更节省gas

代码层级: 
openzepplin 更兼容的是: UUPS
TransparentUpgradeableProxy -> ProxyAdmin (权限管理)
UUPSUpgradeable -> Initializable(初始化)
```

## 什么是时间加权平均价格（TWAP）
```
TWAP = 时间加权平均价格，用于平滑价格波动。
核心作用：平滑价格、防止价格操纵、降低滑点。

Oracle：预言机的价格来源 
Uniswap: 大额订单执行(把大的订单拆分成很多小的订单，分时间段执行)。

```



